{% extends "admin_layout.html" %}

{% block title %}Weekly Roster Editor{% endblock %}

{% block head_extra %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

    :root {
        --primary-color: #00ADB5;
        --dark-bg: #222831;
        --header-bg: #393E46;
        --grid-line-color: #4A515A;
        --text-color: #EEEEEE;
        --off-shift-bg: #FFCDD2;
        --shift-bg: #C8E6C9;
        --employee-header-bg: #008C91;
        --card-bg: #2D333A;
        --weekly-total-data-bg: #F8F8F8;
        --hover-color: #00A6AD;
    }

    /* --- HEADER & UTILITY BAR --- */
    .page-header {
        color: var(--primary-color);
        font-size: 2.2em;
        font-weight: 700;
        margin-top: 65px;

    }

    .utility-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 0;
        width: 100%;
    }

    .nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 15px;
        background-color: var(--header-bg);
        color: var(--text-color);
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.9em;
        transition: background-color 0.2s;
    }

    .nav-btn:hover {
        background-color: #4A515A;
    }

    .week-nav {
        display: flex;
        align-items: center;
        gap: 15px;
        color: var(--text-color);
        font-size: 1.1em;
        font-weight: 600;
        flex-wrap: wrap;
        justify-content: center;
    }

    .date-info strong {
        color: var(--primary-color);
    }

    .date-separator {
        padding: 0 5px;
        font-weight: 600;
        color: var(--text-color);
    }

    .prev-next-btn {
        background-color: var(--primary-color);
        color: var(--dark-bg);
    }

    .prev-next-btn:hover {
        background-color: var(--hover-color);
        color: white;
    }

    .back-btn {
        margin-bottom: 10px;
    }

    /* --- GRID LAYOUT --- */
    .roster-grid-container {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        background-color: var(--header-bg);
        width: 100%;
        max-width: 100%;
    }

    .roster-form {
        display: grid;
        grid-template-columns: 150px repeat(7, 1fr) 120px;
        min-width: 800px;
    }

    .cell {
        padding: 5px 8px;
        border: 1px solid var(--grid-line-color);
        text-align: center;
        font-size: 0.9em;
        height: 50px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-evenly;
        color: var(--dark-bg);
        box-sizing: border-box;
    }

    .header {
        background-color: var(--primary-color);
        color: var(--dark-bg);
        font-weight: 700;
        height: 40px;
        font-size: 1em;
    }

    .employee-column .cell:not(.header) {
        background-color: var(--employee-header-bg);
        color: var(--text-color);
        font-weight: 600;
        text-align: left;
        padding-left: 10px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .employee-column .cell:not(.header):hover {
        background-color: var(--hover-color);
    }

    .shift-time-group {
        display: flex;
        width: 100%;
        align-items: center;
        justify-content: center;
        margin-bottom: 2px;
    }

    .shift-time-group input {
        width: 49%;
        border: 1px solid #ccc;
        padding: 0 2px;
        background-color: white;
        font-size: 0.75em;
        height: 18px;
    }

    .shift-time-group span {
        width: 2%;
        text-align: center;
        color: var(--dark-bg);
        font-weight: 600;
        font-size: 0.75em;
    }

    .shift-duration {
        font-size: 0.75em;
        font-weight: 600;
        color: #616161;
    }

    .off-shift-cell .shift-duration {
        display: none;
    }

    .shift-assigned-cell {
        background-color: var(--shift-bg);
    }

    .off-shift-cell {
        background-color: var(--off-shift-bg);
    }

    .total-hours-cell {
        background-color: #E3F2FD;
        font-weight: 700;
    }

    .grand-total-cell {
        background-color: #C8E6C9;
        font-weight: 800;
    }

    /* Grand total filler cells */
    .grand-total-fill {
        background-color: var(--card-bg);
        border: 1px solid var(--grid-line-color);
    }

    /* --- LEGEND & BUTTON --- */
    .legend-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 30px;
        margin-top: 20px;
        padding: 10px 20px;
        background-color: var(--card-bg);
        border-radius: 8px;
        width: 100%;
        color: var(--text-color);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
    }

    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 3px;
        border: 1px solid #333;
    }

    .legend-off {
        background-color: var(--off-shift-bg);
    }

    .legend-shift {
        background-color: var(--shift-bg);
    }

    .save-btn-container {
        text-align: center;
        margin: 30px 0;
    }

    .save-btn {
        padding: 12px 25px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .save-btn:hover {
        background-color: #388E3C;
    }

    /* --- MOBILE RESPONSIVENESS --- */
    @media (max-width: 768px) {
        .page-header {
            font-size: 1.6em;
            text-align: center;
        }
        .week-nav {
            flex-direction: column;
            gap: 8px;
            text-align: center;
        }
        .roster-form {
            font-size: 0.8em;
            min-width: 600px;
        }
        .cell {
            height: 45px;
            font-size: 0.8em;
        }
        .shift-time-group input {
            height: 20px;
            font-size: 0.7em;
        }
        .save-btn {
            width: 90%;
        }
    }

</style>

<script>
    function parseTime(timeStr) {
        if (!timeStr) return null;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return (hours * 60) + minutes;
    }

    function formatDuration(totalMinutes) {
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours}h ${minutes}min`;
    }

    function updateDuration(empDayKey) {
        const startInput = document.querySelector(`input[name^="shift_start_"][data-emp-day="${empDayKey}"]`);
        const endInput = document.querySelector(`input[name^="shift_end_"][data-emp-day="${empDayKey}"]`);
        const durationSpan = document.querySelector(`.shift-duration[data-emp-day="${empDayKey}"]`);
        if (!startInput || !endInput || !durationSpan) return;

        const startTime = startInput.value;
        const endTime = endInput.value;
        let durationInMinutes = 0;

        if (startTime && endTime) {
            const startMinutes = parseTime(startTime);
            let endMinutes = parseTime(endTime);
            if (endMinutes < startMinutes) endMinutes += (24 * 60);
            durationInMinutes = endMinutes - startMinutes;
        }

        if (durationInMinutes > 0) {
            durationSpan.textContent = formatDuration(durationInMinutes);
            durationSpan.dataset.minutes = durationInMinutes;
            durationSpan.closest('.cell').classList.add('shift-assigned-cell');
            durationSpan.closest('.cell').classList.remove('off-shift-cell');
        } else {
            durationSpan.textContent = '';
            durationSpan.dataset.minutes = 0;
            durationSpan.closest('.cell').classList.add('off-shift-cell');
            durationSpan.closest('.cell').classList.remove('shift-assigned-cell');
        }

        updateEmployeeTotal(empDayKey.split('_')[0]);
    }

    function updateEmployeeTotal(empId) {
        let totalMinutes = 0;
        const durations = document.querySelectorAll(`.shift-duration[data-emp-day^="${empId}_"]`);
        durations.forEach(span => {
            totalMinutes += parseInt(span.dataset.minutes || 0);
        });
        const totalCell = document.querySelector(`.total-hours-cell[data-emp="${empId}"]`);
        if (totalCell) totalCell.textContent = formatDuration(totalMinutes);
        updateGrandTotal();
    }

    function updateGrandTotal() {
        let grandTotalMinutes = 0;
        const totals = document.querySelectorAll('.total-hours-cell');
        totals.forEach(cell => {
            const text = cell.textContent.trim();
            if (text.includes('h')) {
                const [h, m] = text.replace('min', '').split('h').map(t => parseInt(t) || 0);
                grandTotalMinutes += (h * 60 + m);
            }
        });
        const grandCell = document.getElementById('grand-total-cell');
        if (grandCell) grandCell.textContent = formatDuration(grandTotalMinutes);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const timeInputs = document.querySelectorAll('.shift-input');
        timeInputs.forEach(input => {
            const empDayKey = input.getAttribute('data-emp-day');
            updateDuration(empDayKey);
            input.addEventListener('input', () => updateDuration(empDayKey));
        });
    });
</script>
{% endblock %}

{% block content %}
<h1 class="page-header">Weekly Roster Editor</h1>

<div class="utility-bar">
    <a href="{{ url_for('admin_panel') }}" class="back-btn nav-btn">
        <i class="fas fa-arrow-left"></i> Back to Admin Panel
    </a>

    <div class="week-nav">
        <a href="{{ url_for('admin_roster_editor', week_offset=(week_offset - 1)) }}" class="prev-next-btn nav-btn">
            <i class="fas fa-chevron-left"></i> Previous Week
        </a>
        <div class="date-info">
            Week: <strong>{{ nav_dates.start|default('YYYY-MM-DD') }}</strong>
            <span class="date-separator">to</span>
            <strong>{{ nav_dates.end|default('YYYY-MM-DD') }}</strong>
            {% if current_week %} (Current Week) {% endif %}
        </div>
        <a href="{{ url_for('admin_roster_editor', week_offset=(week_offset + 1)) }}" class="prev-next-btn nav-btn">
            Next Week <i class="fas fa-chevron-right"></i>
        </a>
    </div>
</div>

<div class="roster-grid-container">
    <form method="POST" action="{{ url_for('admin_roster_editor', week_offset=week_offset) }}" id="roster-form" class="roster-form">
        <input type="hidden" name="week_start_date" value="{{ nav_dates.start|default('') }}">
        <input type="hidden" name="week_offset" value="{{ week_offset }}">

        <!-- Employee Column -->
        <div class="employee-column">
            <div class="cell header">Employee</div>
            {% for employee in employees %}
                <div class="cell">{{ employee.name }}</div>
            {% endfor %}
            <div class="cell grand-total-cell">Grand Total</div>
        </div>

        <!-- Days Columns -->
        {% for header_str in date_headers %}
            {% set day_name = header_str.split(' ')[0] %}
            {% set date_only = header_str.split(' ')[1] %}
            <div class="day-column">
                <div class="cell header">{{ header_str }}</div>
                {% for employee in employees %}
                    {% set emp_id = employee['emp_id'] %}
                    {% set shift_data = week_data.get(emp_id, {}).get(day_name, 'OFF') %}
                    {% set is_off = shift_data|upper == 'OFF' or shift_data == '' %}
                    {% set cell_class = 'off-shift-cell' if is_off else 'shift-assigned-cell' %}
                    {% set parts = shift_data.split(' - ') %}
                    {% set start_time = parts[0]|trim if not is_off and parts|length == 2 else '' %}
                    {% set end_time = parts[1]|trim if not is_off and parts|length == 2 else '' %}
                    {% set emp_day_key = emp_id ~ '_' ~ date_only %}
                    <div class="cell {{ cell_class }}">
                        <div class="shift-time-group">
                            <input type="time" name="shift_start_{{ emp_id }}_{{ date_only }}" class="shift-input" value="{{ start_time }}" data-emp-day="{{ emp_day_key }}">
                            <span>-</span>
                            <input type="time" name="shift_end_{{ emp_id }}_{{ date_only }}" class="shift-input" value="{{ end_time }}" data-emp-day="{{ emp_day_key }}">
                        </div>
                        <span class="shift-duration" data-emp-day="{{ emp_day_key }}" data-minutes="0"></span>
                    </div>
                {% endfor %}
                <div class="cell grand-total-fill"></div>
            </div>
        {% endfor %}

        <!-- Totals Column -->
        <div class="total-hours-column">
            <div class="cell header">Total Hours</div>
            {% for employee in employees %}
                <div class="cell total-hours-cell" data-emp="{{ employee.emp_id }}">0h 0min</div>
            {% endfor %}
            <div class="cell grand-total-cell" id="grand-total-cell">0h 0min</div>
        </div>
    </form>
</div>

<div class="legend-container">
    <div class="legend-item">
        <span class="legend-color legend-shift"></span> Shift Assigned (e.g., 09:00-17:00)
    </div>
    <div class="legend-item">
        <span class="legend-color legend-off"></span> Day Off (Leave blank)
    </div>
</div>

<div class="save-btn-container">
    <button type="submit" form="roster-form" class="save-btn">
        <i class="fas fa-save"></i> Save Roster
    </button>
</div>
{% endblock %}
